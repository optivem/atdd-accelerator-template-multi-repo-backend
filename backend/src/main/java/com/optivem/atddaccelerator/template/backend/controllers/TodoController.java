package com.optivem.atddaccelerator.template.backend.controllers;

import com.optivem.atddaccelerator.template.backend.models.Todo;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestClientException;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.server.ResponseStatusException;

import java.time.Duration;

@RestController
@RequestMapping("/api")
@CrossOrigin(origins = "http://localhost:8080")
public class TodoController {

    @Value("${todos.api.host}")
    private String todosApiHost;

    private final RestTemplate restTemplate;

    public TodoController(RestTemplateBuilder restTemplateBuilder) {
        this.restTemplate = restTemplateBuilder
                .setConnectTimeout(Duration.ofSeconds(30))
                .setReadTimeout(Duration.ofSeconds(30))
                .build();
    }

    @GetMapping("/todos/{id}")
    public Todo getTodo(@PathVariable int id) {
        String url = todosApiHost + "/todos/" + id;
        
        int maxRetries = 3;
        int retryDelayMs = 1000;
        
        for (int attempt = 0; attempt < maxRetries; attempt++) {
            try {
                Todo todo = restTemplate.getForObject(url, Todo.class);
                if (todo == null) {
                    throw new ResponseStatusException(HttpStatus.NOT_FOUND, "Todo not found");
                }
                return todo;
            } catch (RestClientException e) {
                if (attempt == maxRetries - 1) {
                    throw new ResponseStatusException(
                        HttpStatus.SERVICE_UNAVAILABLE, 
                        "External API is unavailable after " + maxRetries + " attempts: " + e.getMessage(), 
                        e
                    );
                }
                
                try {
                    Thread.sleep(retryDelayMs);
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    throw new ResponseStatusException(
                        HttpStatus.INTERNAL_SERVER_ERROR, 
                        "Retry interrupted", 
                        ie
                    );
                }
            }
        }
        
        throw new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, "Unexpected error");
    }
}